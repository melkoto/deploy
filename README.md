# deploy

## Dockerfile для React-приложения
- `FROM node:14 as build`: Используем официальный образ Node.js версии 14 и называем этот этап сборки build. 
- `WORKDIR /usr/src/app`: Устанавливает рабочую директорию внутри контейнера на /usr/src/app. 
- `COPY package*.json ./`: Копирует файлы package.json и package-lock.json из текущей директории (на вашей машине) в рабочую директорию контейнера (/usr/src/app).
- `RUN npm install`: Устанавливает все зависимости, указанные в файлах package.json и package-lock.json. 
- `COPY . .`: Копирует все файлы и папки из текущей директории (где находится Dockerfile) в рабочую директорию контейнера (/usr/src/app). 
- `RUN npm run build`: Выполняет команду npm run build, которая собирает ваше React-приложение в оптимизированный для продакшена набор файлов, обычно в директорию build. 
- `FROM nginx:alpine`: Используем легковесный образ nginx для сервировки статических файлов. Это новый этап сборки, основанный на образе nginx. 
- `COPY --from=build /usr/src/app/build /usr/share/nginx/html`: Копируем собранные файлы из директории build предыдущего этапа сборки (build) в директорию, откуда nginx будет сервировать статические файлы (/usr/share/nginx/html). 
- `COPY nginx.conf /etc/nginx/nginx.conf`: Копирует ваш файл конфигурации nginx в контейнер, заменяя стандартную конфигурацию nginx на вашу. 
- `EXPOSE 80`: Указывает Docker, что контейнер будет слушать порт 80. Это стандартный порт для HTTP. 
- `CMD ["nginx", "-g", "daemon off;"]`: Запускает nginx с параметром daemon off;, чтобы nginx работал в переднем плане и контейнер оставался активным.

## Dockerfile для Express-приложения
- `FROM node:14`: Используем официальный образ Node.js версии 14 в качестве базового образа. 
- `WORKDIR /usr/src/app`: Устанавливает рабочую директорию внутри контейнера на /usr/src/app. 
- `COPY package*.json ./`: Копирует файлы package.json и package-lock.json из текущей директории на вашей машине в рабочую директорию контейнера (/usr/src/app). 
- `RUN npm install`: Устанавливает все зависимости, указанные в файлах package.json и package-lock.json. 
- `COPY . .`: Копирует все файлы и папки из текущей директории на вашей машине в рабочую директорию контейнера (/usr/src/app). 
- `EXPOSE 3000`: Указывает Docker, что контейнер будет слушать порт 3000. Это стандартный порт для Express-приложений. 
- `CMD ["node", "app.js"]`: Запускает ваше Express-приложение, выполняя команду node app.js.

## Конфигурационный файл Nginx (nginx.conf)
- `listen 80;`: Указывает Nginx слушать на порту 80, который является стандартным портом для HTTP. 
- `location / { ... }`: Конфигурация для маршрута /, который является корнем вашего сайта. 
  - `root /usr/share/nginx/html;`: Указывает директорию, где находятся статические файлы вашего React-приложения.`
  - `index index.html index.htm;`: Указывает файл, который будет использоваться в качестве главной страницы (index). 
  - `try_files $uri $uri/ /index.html;`: Если запрашиваемый файл не найден, перенаправляет все запросы на index.html, что необходимо для правильной работы клиентских маршрутизаций в SPA (Single Page Application). 
- `location /api { ... }`: Конфигурация для маршрута /api, который будет проксировать запросы на ваше Express-приложение. 
  - `proxy_pass http://express-app:3000;`: Перенаправляет все запросы с префиксом /api на ваш контейнер с Express-приложением, работающий на порту 3000. 
  - `proxy_set_header ...;`: Эти строки добавляют дополнительные заголовки к проксируемым запросам. 
    - `proxy_set_header Host $host;`: Передает оригинальный хост заголовок. 
    - `proxy_set_header X-Real-IP $remote_addr;`: Передает IP-адрес клиента. 
    - `proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;`: Передает список IP-адресов, через которые прошел запрос. 
    - `proxy_set_header X-Forwarded-Proto $scheme;`: Передает протокол (http или https).

## Конфигурация Docker Compose

Этот файл `docker-compose.yml` определяет конфигурацию для многоконтейнерного Docker приложения, состоящего из приложения на Express, приложения на React и базы данных PostgreSQL. Ниже приведено подробное объяснение каждой части файла.

```yaml
version: '3' # Указывает версию синтаксиса Docker Compose. В данном случае используется версия 3, которая поддерживает множество современных функций Docker Compose.

services: # Определяет все сервисы (контейнеры), которые будут запущены.
  express-app: # Имя сервиса для вашего Express-приложения.
    build: ./backend # Указывает Docker Compose использовать Dockerfile, находящийся в директории ./backend, для сборки образа этого сервиса.
    ports:
      - "3000:3000" # Пробрасывает порты из контейнера на хост. В данном случае порт 3000 контейнера будет доступен на порту 3000 хоста.
    networks:
      - app-network # Указывает, что контейнер будет подключен к сети app-network.
    environment: # Определяет переменные окружения, которые будут переданы в контейнер.
      - POSTGRES_USER=${POSTGRES_USER} # Пользователь базы данных.
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD} # Пароль пользователя базы данных.
      - POSTGRES_DB=${POSTGRES_DB} # Имя базы данных.
    depends_on:
      - postgres # Указывает, что этот сервис зависит от сервиса postgres. Это означает, что сервис postgres будет запущен перед запуском express-app.

  react-app: # Имя сервиса для вашего React-приложения.
    build: ./frontend # Указывает Docker Compose использовать Dockerfile, находящийся в директории ./frontend, для сборки образа этого сервиса.
    ports:
      - "80:80" # Пробрасывает порты из контейнера на хост. В данном случае порт 80 контейнера будет доступен на порту 80 хоста.
    networks:
      - app-network # Указывает, что контейнер будет подключен к сети app-network.

  postgres: # Имя сервиса для базы данных PostgreSQL.
    image: postgres:13 # Указывает Docker использовать официальный образ PostgreSQL версии 13.
    restart: always # Указывает, что контейнер будет автоматически перезапущен в случае сбоя.
    environment: # Определяет переменные окружения для конфигурации базы данных PostgreSQL.
      POSTGRES_USER: ${POSTGRES_USER} # Пользователь базы данных.
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD} # Пароль пользователя базы данных.
      POSTGRES_DB: ${POSTGRES_DB} # Имя базы данных.
    volumes:
      - pgdata:/var/lib/postgresql/data # Создает и монтирует том для хранения данных базы данных. Данные в томе pgdata будут сохраняться вне контейнера, чтобы они не потерялись при перезапуске или удалении контейнера.
    networks:
      - app-network # Указывает, что контейнер будет подключен к сети app-network.

networks: # Определяет пользовательские сети, которые будут использоваться сервисами.
  app-network: # Имя сети, которую будут использовать все сервисы.
    driver: bridge # Указывает, что сеть будет типа bridge, которая является стандартной сетевой конфигурацией Docker и позволяет контейнерам общаться друг с другом.

volumes: # Определяет тома, которые будут использоваться для хранения данных.
  pgdata: # Имя тома, который будет использоваться для хранения данных PostgreSQL. Этот том гарантирует, что данные базы данных сохранятся даже после остановки или удаления контейнера.

docker-compose -f docker-compose.yml -f docker-compose.override.yml up --build -d

docker-compose exec express-app npx sequelize db:migrate
